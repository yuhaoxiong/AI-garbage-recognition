# IO控制和动画功能说明

## 概述

本文档详细说明了废弃物AI识别指导投放系统中的IO控制和动画功能。系统现在支持红外传感器IO控制，只有在检测到红外信号时才进行图像识别，并在识别到垃圾时播放动画效果。

## 功能特性

### 1. IO控制功能

- **红外传感器监控**：系统监控红外传感器（GPIO Pin 18）的状态变化
- **智能触发**：只有在检测到红外信号时才启动AI检测，节省计算资源
- **防抖处理**：内置防抖机制，避免信号波动导致的误触发
- **超时控制**：设置检测超时时间，避免长时间无响应
- **模拟模式**：在无GPIO环境下自动切换到模拟模式进行测试

### 2. 动画功能

- **等待动画**：用户接近时播放的提示动画
- **检测动画**：AI检测过程中的脉冲动画
- **成功动画**：识别成功时的粒子特效和勾选标记
- **错误动画**：检测失败时的错误提示动画
- **响应式设计**：动画大小和效果随窗口大小自适应

## 系统架构

### 核心组件

1. **IOControlWorker** (`worker/io_control_worker.py`)
   - 负责红外传感器信号监控
   - 处理IO信号的防抖和超时
   - 发送检测触发信号

2. **AnimationWidget** (`ui/animation_widget.py`)
   - 管理各种动画效果
   - 粒子系统、脉冲动画、成功标记等
   - 动画状态管理和事件通知

3. **WasteDetectionWorker** (`worker/waste_detection_worker.py`)
   - 修改为支持IO控制的检测模式
   - 只在IO信号触发时进行AI推理
   - 优化资源使用

4. **MainWindow** (`ui/main_window.py`)
   - 集成IO控制和动画功能
   - 处理各组件间的信号传递
   - 三栏布局：摄像头、动画、指导界面

## 配置说明

### IO控制配置

在 `config/system_config.json` 中添加了以下配置：

```json
{
  "io_control": {
    "enable_io_control": true,
    "ir_sensor_pin": 18,
    "detection_delay": 0.5,
    "detection_timeout": 10,
    "debounce_time": 0.1
  }
}
```

**配置参数说明：**

- `enable_io_control`: 是否启用IO控制功能
- `ir_sensor_pin`: 红外传感器连接的GPIO引脚号
- `detection_delay`: 检测延迟时间（秒），给用户放置物品的时间
- `detection_timeout`: 检测超时时间（秒），避免长时间检测
- `debounce_time`: 防抖时间（秒），避免信号波动

### 动画配置

```json
{
  "animation": {
    "enable_animations": true,
    "particle_count": 20,
    "animation_duration": 3000,
    "success_animation_duration": 2000,
    "pulse_animation_fps": 20
  }
}
```

**配置参数说明：**

- `enable_animations`: 是否启用动画功能
- `particle_count`: 粒子特效的粒子数量
- `animation_duration`: 动画持续时间（毫秒）
- `success_animation_duration`: 成功动画持续时间（毫秒）
- `pulse_animation_fps`: 脉冲动画帧率

## 使用方法

### 1. 正常使用流程

1. **系统启动**：启动主应用程序，系统自动初始化IO控制和动画组件
2. **用户接近**：当用户接近红外传感器时，系统检测到信号
3. **等待动画**：播放等待动画，提示用户放置物品
4. **开始检测**：延迟0.5秒后开始AI检测，播放检测动画
5. **显示结果**：
   - 识别成功：播放成功动画，显示分类结果和投放指导
   - 识别失败：播放错误动画，显示错误信息
6. **用户离开**：红外信号消失后，系统停止检测，重置动画

### 2. 测试方法

运行测试程序验证功能：

```bash
cd 废弃物AI识别指导投放项目
python test_io_animation.py
```

测试程序提供以下功能：

- **IO控制测试**：启动/停止IO控制，手动触发检测
- **动画测试**：播放各种动画效果
- **状态监控**：实时查看IO状态和动画状态
- **日志输出**：详细的操作日志和错误信息

## 信号流程

### IO控制信号流

```
红外传感器变化 → IOControlWorker → 信号处理 → 主窗口 → 动画播放
                                     ↓
                              WasteDetectionWorker → AI检测 → 结果处理
```

### 动画播放流程

```
用户接近 → 等待动画 → 检测动画 → 成功/错误动画 → 重置动画
```

## 硬件连接

### 红外传感器连接

- **VCC**: 连接到3.3V或5V电源
- **GND**: 连接到接地线
- **OUT**: 连接到GPIO 18（BCM编号）

### 传感器特性

- **检测距离**: 通常2-30cm可调
- **响应时间**: 通常100-200ms
- **输出逻辑**: 高电平表示无物体，低电平表示检测到物体

## 故障排除

### 常见问题

1. **IO控制无法启动**
   - 检查是否安装了RPi.GPIO库
   - 确认GPIO引脚配置正确
   - 检查传感器硬件连接

2. **动画不显示**
   - 检查配置文件中是否启用了动画
   - 确认PySide6版本兼容性
   - 查看日志文件中的错误信息

3. **检测不准确**
   - 调整红外传感器的检测距离
   - 修改防抖时间配置
   - 检查传感器位置和角度

### 调试方法

1. **启用调试日志**：
   ```python
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **查看系统日志**：
   ```bash
   tail -f logs/waste_detection.log
   ```

3. **使用测试程序**：
   ```bash
   python test_io_animation.py
   ```

## 开发扩展

### 添加新的动画效果

1. 在 `AnimationWidget` 中添加新的动画类
2. 实现动画的绘制和更新逻辑
3. 添加控制方法和信号处理

### 支持其他传感器

1. 修改 `IOControlWorker` 中的硬件接口
2. 添加相应的配置参数
3. 实现新的信号处理逻辑

### 优化性能

1. 调整动画帧率和持续时间
2. 优化粒子系统的计算
3. 使用GPU加速（如果支持）

## 注意事项

1. **资源占用**：动画功能会增加CPU和GPU使用率
2. **硬件兼容性**：GPIO功能仅在树莓派等支持的平台上可用
3. **电源要求**：确保系统有足够的电源供应传感器和处理器
4. **环境适应**：红外传感器可能受到环境光照影响
5. **维护更新**：定期检查传感器状态和清理镜头

## 版本更新

### 当前版本：1.0.0

- 基础IO控制功能
- 完整动画系统
- 三栏响应式布局
- 完善的错误处理

### 计划更新：

- 支持多种传感器类型
- 自定义动画效果
- 远程监控和控制
- 数据统计和分析 