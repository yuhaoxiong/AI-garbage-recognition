# 运动检测拍照和API调用使用说明

## 🔍 问题描述

用户反映"检测到事件时没有拍照并通过API传给大模型"。

## 💡 问题原因

运动检测功能需要正确的启用步骤，默认情况下系统运行在**RKNN模式**，而不是**运动检测模式**。

## ✅ 正确的启用步骤

### 方法一：通过菜单切换模式（推荐）

1. **启动主程序**
   ```bash
   python main.py
   ```

2. **切换到运动检测模式**
   - 菜单栏 → 检测 → 运动检测模式 ✓

3. **开始检测**
   - 点击"开始检测"按钮
   - 或菜单栏 → 检测 → 开始检测

4. **验证状态**
   - 界面底部状态栏显示："检测: 运动检测运行中"

### 方法二：手动启用运动检测

1. **启动主程序并开始检测**
   ```bash
   python main.py
   ```
   - 点击"开始检测"（此时是RKNN模式）

2. **启用运动检测**
   - 菜单栏 → 检测 → 启用运动检测 ✓

3. **验证状态**  
   - 界面底部状态栏显示："运动检测: 启用"

## 🔄 完整的工作流程

### 当检测到运动时：
```
📷 摄像头捕获帧
    ↓
🔍 运动检测器分析背景变化
    ↓
📊 检测到运动（轮廓面积 >= 阈值）
    ↓
📸 自动拍照保存到 data/captured_images/
    ↓
🌐 调用大模型API进行识别
    ↓
📄 解析API返回的垃圾分类结果
    ↓
🎯 显示分类指导和播放语音
```

### 拍照文件命名格式：
```
motion_detected_20231123_143052_123.jpg
```

### API调用结果格式：
```json
{
    "category": "可回收物",
    "confidence": 0.95,
    "description": "这是一个塑料瓶，属于可回收物",
    "image_path": "data/captured_images/motion_detected_xxx.jpg",
    "detection_method": "motion_detection",
    "timestamp": "2023-11-23T14:30:52"
}
```

## ⚙️ 配置文件说明

### 运动检测配置
```json
{
  "motion_detection": {
    "enable_motion_detection": true,     // ✓ 必须为true
    "motion_threshold": 500,             // 运动检测灵敏度
    "min_contour_area": 1000,           // 最小有效面积
    "detection_cooldown": 10.0,         // 冷却时间（秒）
    "history": 500,                     // 背景学习帧数
    "dist2_threshold": 400.0,           // 距离阈值
    "detect_shadows": true,             // 检测阴影
    "blur_kernel_size": 5,              // 高斯模糊核大小
    "kernel_size": 3                    // 形态学操作核大小
  }
}
```

### API配置
```json
{
  "api": {
    "api_url": "https://api.siliconflow.cn/v1/chat/completions",
    "api_key": "sk-your-api-key-here",  // ✓ 需要有效的API密钥
    "model_name": "THUDM/GLM-4.1V-9B-Thinking",
    "max_retries": 3,                   // 最大重试次数
    "timeout": 30                       // 超时时间（秒）
  }
}
```

## 🐛 常见问题和解决方案

### 1. 没有触发拍照
**问题**：在摄像头前挥手，但没有拍照
**原因**：
- 未切换到运动检测模式
- 运动幅度太小，未达到检测阈值
- 处在冷却期内

**解决方案**：
- 确认已切换到运动检测模式
- 增大运动幅度或降低 `min_contour_area` 阈值
- 等待冷却时间结束（默认10秒）

### 2. 拍照了但没有API调用
**问题**：看到拍照文件，但没有识别结果
**原因**：
- API密钥无效或过期
- 网络连接问题
- API服务不可用

**解决方案**：
- 检查API密钥是否正确
- 检查网络连接
- 查看日志文件：`logs/waste_detection.log`

### 3. API调用失败
**问题**：日志显示API调用错误
**常见错误和解决方案**：

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `API识别失败` | 网络问题或API错误 | 检查网络和API配置 |
| `图片保存失败` | 磁盘空间不足 | 清理磁盘空间 |
| `运动检测结果帧格式不正确` | 图像格式问题 | 重启程序 |

## 📊 调试和监控

### 查看日志
```bash
# 实时查看日志
tail -f logs/waste_detection.log

# 搜索运动检测相关日志
grep "运动检测" logs/waste_detection.log
grep "API" logs/waste_detection.log
```

### 关键日志信息
- `运动检测已启用` - 确认运动检测功能已开启
- `检测到运动，面积: XXX` - 确认运动被检测到
- `图片已保存: XXX` - 确认拍照成功
- `开始调用API进行识别` - 确认API调用开始
- `API识别成功: XXX` - 确认API调用成功

### 检查拍照文件
```bash
# 查看拍照目录
ls -la data/captured_images/

# 查看最新拍照文件
ls -t data/captured_images/ | head -5
```

## 🧪 测试步骤

### 基本功能测试
1. **启动程序并切换到运动检测模式**
2. **在摄像头前进行明显的运动**（如挥手）
3. **观察状态变化**：
   - 日志中应显示"检测到运动"
   - `data/captured_images/` 目录应有新的图片文件
   - 界面应显示识别结果

### 参数调试测试
1. **打开运动检测测试界面**
   - 菜单栏 → 设置 → 运动检测测试界面
2. **实时观察检测过程**
3. **调整参数优化检测效果**

## 🎯 性能优化建议

### 提高检测灵敏度
- 降低 `min_contour_area`（如从1000降到500）
- 降低 `motion_threshold`（如从500降到300）

### 减少误触发
- 增加 `detection_cooldown`（如从10秒增加到15秒）
- 增大 `min_contour_area`（如从1000增加到1500）

### 优化API性能
- 调整 `timeout` 时间
- 配置 `max_retries` 重试次数
- 选择合适的 `model_name`

## 📱 用户界面指示

### 状态指示
- **检测状态**：底部状态栏显示当前检测模式
- **运动检测状态**：显示"运动检测: 启用/禁用"
- **菜单状态**：对应菜单项有勾选标记

### 视觉反馈
- **运动检测测试界面**：实时显示检测过程
- **主界面**：可选择显示运动检测结果
- **指导界面**：显示API识别的结果

## 🔧 故障排除检查清单

- [ ] 系统配置：`enable_motion_detection: true`
- [ ] API配置：有效的`api_key`和正确的`api_url`
- [ ] 检测模式：已切换到"运动检测模式"
- [ ] 检测状态：已点击"开始检测"
- [ ] 网络连接：可以访问API服务
- [ ] 磁盘空间：足够保存拍照文件
- [ ] 摄像头权限：程序可以访问摄像头
- [ ] 日志信息：无错误或警告信息

---

*通过正确的操作步骤，运动检测功能可以实现自动拍照和API调用，为用户提供智能的垃圾分类指导。* 