# 运动检测功能说明

## 功能概述

运动检测功能是废弃物AI识别指导投放系统的新增识别手段，可以与RKNN识别进行切换。当检测到有物体进入摄像头视野范围时，系统会自动拍照并上传给大模型API进行识别，然后给出对应的垃圾类型指导。

## 核心特性

### 1. 运动检测
- **背景减除算法**：使用OpenCV的KNN背景减除器
- **轮廓检测**：检测运动物体的轮廓和面积
- **参数可调**：运动阈值、最小轮廓面积、检测冷却时间等
- **防误触发**：冷却机制防止连续误触发

### 2. 自动拍照
- **实时捕获**：检测到运动时立即拍照
- **时间戳命名**：使用精确时间戳命名图片文件
- **自动保存**：保存到`data/captured_images`目录

### 3. 大模型API调用
- **支持多种API**：OpenAI GPT-4 Vision、Claude等
- **图片编码**：自动将图片编码为base64格式
- **JSON解析**：智能解析API返回的JSON结果
- **错误处理**：网络异常时自动降级到模拟识别

### 4. 模式切换
- **RKNN模式**：使用本地RKNN模型进行实时检测
- **运动检测模式**：使用运动检测+API的方式进行检测
- **无缝切换**：两种模式可以随时切换

## 系统架构

```
摄像头 → 运动检测器 → 图片捕获 → API客户端 → 大模型识别 → 结果处理
   ↓
RKNN检测器 ← 模式切换 → 运动检测器
```

### 核心组件

1. **MotionDetector**：运动检测器
   - 背景减除
   - 轮廓检测
   - 运动判断

2. **APIClient**：API客户端
   - 图片编码
   - 请求发送
   - 结果解析

3. **MotionDetectionWorker**：工作线程
   - 检测循环
   - 信号管理
   - 状态控制

## 配置说明

### 运动检测配置
```json
{
  "motion_detection": {
    "enable_motion_detection": false,
    "motion_threshold": 500,
    "min_contour_area": 1000,
    "detection_cooldown": 3.0,
    "history": 500,
    "dist2_threshold": 400.0,
    "detect_shadows": true,
    "blur_kernel_size": 5,
    "kernel_size": 3
  }
}
```

### API配置
```json
{
  "api": {
    "api_url": "https://api.openai.com/v1/chat/completions",
    "api_key": "your_api_key_here",
    "model_name": "gpt-4-vision-preview",
    "max_retries": 3,
    "timeout": 30
  }
}
```

## 使用方法

### 1. 启用运动检测
在配置文件`config/system_config.json`中设置：
```json
"motion_detection": {
  "enable_motion_detection": true
}
```

### 2. 配置API密钥
在API配置中添加你的API密钥：
```json
"api": {
  "api_key": "sk-your-api-key-here"
}
```

### 3. 启动程序
```bash
python main.py
```

### 4. 切换检测模式
- 菜单栏 → 检测 → RKNN模式/运动检测模式
- 或者使用菜单中的"启用运动检测"选项

## 工作流程

### 运动检测模式流程
1. **初始化**：启动摄像头和运动检测器
2. **背景学习**：系统学习当前场景的背景
3. **运动检测**：持续监控画面变化
4. **触发拍照**：检测到运动时自动拍照
5. **API调用**：将图片发送给大模型API
6. **结果处理**：解析API返回的垃圾类型
7. **指导显示**：显示分类结果和投放指导
8. **动画播放**：播放对应的动画效果
9. **语音播报**：播放语音指导

### 信号流程
```
MotionDetectionWorker
├── motion_detected → 主窗口状态更新
├── image_captured → 记录图片路径
├── api_result_received → 显示API结果
├── detection_completed → 更新指导界面
└── error_occurred → 错误处理
```

## 参数调优

### 运动检测参数
- **motion_threshold**：运动检测阈值，值越小越敏感
- **min_contour_area**：最小轮廓面积，过滤小物体
- **detection_cooldown**：检测冷却时间，防止连续触发
- **history**：背景学习帧数，影响背景稳定性
- **dist2_threshold**：距离阈值，影响运动检测精度

### API参数
- **max_retries**：最大重试次数
- **timeout**：请求超时时间
- **model_name**：使用的模型名称

## 测试方法

### 1. 基础测试
```bash
python test_motion_detection.py
```

### 2. 功能测试
- 启动测试程序
- 在摄像头前移动物体
- 观察运动检测状态
- 检查图片是否被捕获
- 验证API调用结果

### 3. 参数调优
- 调整运动阈值
- 修改最小轮廓面积
- 设置合适的冷却时间
- 测试不同API模型

## 故障排除

### 常见问题

1. **运动检测不敏感**
   - 降低`motion_threshold`
   - 减小`min_contour_area`
   - 检查摄像头是否正常工作

2. **频繁误触发**
   - 增加`detection_cooldown`
   - 提高`min_contour_area`
   - 调整`dist2_threshold`

3. **API调用失败**
   - 检查网络连接
   - 验证API密钥
   - 确认API配额

4. **图片保存失败**
   - 检查目录权限
   - 确认磁盘空间
   - 验证文件路径

### 调试方法

1. **查看日志**
   ```bash
   tail -f logs/waste_detection.log
   ```

2. **检查配置**
   ```bash
   cat config/system_config.json
   ```

3. **测试API**
   ```bash
   python test_motion_detection.py
   ```

## 性能优化

### 1. 检测性能
- 调整检测频率
- 优化图像预处理
- 使用合适的参数

### 2. API性能
- 设置合理的超时时间
- 配置重试机制
- 使用缓存机制

### 3. 内存管理
- 及时释放图片资源
- 控制图片保存数量
- 定期清理临时文件

## 扩展功能

### 1. 支持更多API
- 添加Claude API支持
- 集成本地大模型
- 支持多模型切换

### 2. 增强检测能力
- 添加物体跟踪
- 支持多物体检测
- 增加方向检测

### 3. 优化用户体验
- 添加检测预览
- 支持参数实时调整
- 增加检测历史记录

## 注意事项

1. **API成本**：使用大模型API会产生费用，请注意控制使用量
2. **网络依赖**：运动检测模式需要网络连接
3. **隐私保护**：捕获的图片会保存到本地，注意隐私保护
4. **性能影响**：API调用会有一定延迟，影响实时性
5. **配置备份**：修改配置前请备份原始文件

## 技术支持

如遇到问题，请：
1. 查看日志文件
2. 检查配置文件
3. 运行测试程序
4. 联系技术支持

---

*运动检测功能为废弃物AI识别指导投放系统提供了更灵活的识别方案，可以根据实际需求选择合适的检测模式。* 